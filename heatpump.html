<!DOCTYPE html>

<head>
    <title>Status Wäremepumpen T71-T77</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/locale/de.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.8.2/css/bulma.min.css">
    <script type="text/javascript">

        /**
         * TODO: Zeiten sind noch UTC
         * Datum ist noch US
         * Graph verbergen und zeigen verzerrt graph
         * 
         **/

        google.charts.load('current', {
            'packages': ['line', 'timeline', 'corechart'], 'language': 'de'
        });
        google.charts.setOnLoadCallback(drawChart);
        var diffLastSample = 0;
        var forwardTemp = 0;
        var timelineRows = [];
        var timelineEntryStarted = false;
        var timeLineMap = new Map();
        var currentTimelineName;
        var collection = "t77-monitor";

        var options = {
            chart: {
                title: 'Rohdaten der gleichen Zeitperiode wie oben. Vorlauf- und Rücklauftemperatur Heizung/Kühlung und Differenz.'
            },
            width: 900,
            height: 500,
            series: {
                // Gives each series an axis name that matches the Y-axis below.
                0: {axis: 'Temps'},
                1: {axis: 'Temps'},
                2: {axis: 'Diff'}
            },
            axes: {
                y: {
                    Temps: {
                        label: 'Temperatur'
                    },
                    Diff: {
                        label: 'Diff'
                    }
                }
            }
        };

        function drawChart() {
            var ajax = $.ajax({
                url: "https://europe-west3-heatpump-monitoring.cloudfunctions.net/doGraphData",
                crossDomain: true,
                dataType: "json",
                async: false,
                data: {
                    collection: collection
                }
            })
                .done(function (jsonData) {

                    let lastSample = jsonData.rows[jsonData.rows.length - 1];
                    diffLastSample = lastSample.c[3].v;
                    forwardTemp = lastSample.c[1].v;
                    //"Date(2020,4,8,20,8)"
                    timeLastSample = lastSample.c[0].v;
                    timeLastSample = timeLastSample.substring(5, timeLastSample.length - 1);
                    let lastMeasurement = moment.utc(timeLastSample.split(",")).format("dddd, MMMM Do YYYY, H:mm");

                    var dateFormatter = new google.visualization.DateFormat({ formatType: 'medium' });
                    var data = new google.visualization.DataTable(jsonData);
                    dateFormatter.format(data, 0);
                    var chart = new google.charts.Line(document.getElementById('lineChart'));
                    chart.draw(data, options);

                    if (diffLastSample > 2) {
                        $("#status").text("Aktueller Status: Kühlung läuft. Vorlauftemperatur Wasser: " + forwardTemp + "(Letzte Messung: " + lastMeasurement + ")");
                    } else if (diffLastSample < -2) {
                        $("#status").text("Aktueller Status: Heizung läuft. Vorlauftemperatur Wasser: " + forwardTemp + "(Letzte Messung: " + lastMeasurement + ")");
                    } else {
                        $("#status").text("Aktueller Status: Standby (Letzte Messung: " + lastMeasurement + ")");
                    }
                    //prepare timeline chart
                    var timelineChart = new google.visualization.Timeline(document.getElementById('timelineChart'));
                    var timelineDataTable = new google.visualization.DataTable();

                    timelineDataTable.addColumn({ type: 'string', id: 'Status' });
                    timelineDataTable.addColumn({ type: 'date', id: 'Start' });
                    timelineDataTable.addColumn({ type: 'date', id: 'End' });

                    // a row {"c":[{"v":"Date(2020,3,1,8,16)"},{"v":19.3},{"v":23.3},{"v":4}]},
                    // date, waterTemp, roomTemp, diff (room-water)
                    jsonData.rows.forEach(row => {
                        let diff = row.c[3].v;
                        let date = row.c[0].v;
                        if (diff > 2) {
                            addToTimeline("Kühlung", date);
                        } else if (diff < -2) {
                            addToTimeline("Heizung", date);
                        } else {
                            addToTimeline("Standby", date);
                        }
                    });
                    addToTimeline("End", new Date());

                    var timelineOptions = {
                        width: 900,
                        height: 500,
                        legend: { position: 'none' },
                        hAxis: {
                            viewWindow: {
                                min: new Date(2020, 3, 11),
                                max: new Date(2020, 4, 11)
                            },
                            gridlines: {
                                count: -1,
                                units: {
                                    days: { format: ['dd.MM.yyyy'] },
                                    hours: { format: ['HH:mm', 'hh'] },
                                    minutes: { format: ['HH:mm', ':mm'] }
                                }
                            },
                            minorGridlines: {
                                units: {
                                    days: { format: ['dd.MM.yyyy'] },
                                    hours: { format: ['hh:mm:ss', 'hh'] },
                                    minutes: { format: ['HH:mm', ':mm'] }
                                }
                            }
                        }
                    };


                    let wrap = [];
                    wrap.push(timelineRows);
                    timelineDataTable.addRows(timelineRows);

                    timelineChart.draw(timelineDataTable, timelineOptions);

                })
                .fail(function (e) {
                    console.log("Error calling cloud function: " + e);
                });

        }

        //[ 'Heizung', new Date(1789, 3, 30), new Date(1797, 2, 4) ],
        function addToTimeline(timelineName, date) {
            if (currentTimelineName == undefined || currentTimelineName == "" || currentTimelineName == timelineName) {
                if (!timelineEntryStarted) {
                    //create a new one
                    timeLineMap.set(timelineName, { startdate: date, enddate: date });
                    currentTimelineName = timelineName;
                    timelineEntryStarted = true;
                } else {
                    //add new end time
                    let entry = timeLineMap.get(timelineName);
                    entry.enddate = date;
                    timeLineMap.set(timelineName, entry);
                }
            } else {
                //finish current timeline entry and start new one
                let entry = timeLineMap.get(currentTimelineName);
                let startdate = entry.startdate;
                let enddate = entry.enddate;
                let rowEntry = [currentTimelineName, startdate, enddate];
                timelineRows.push(rowEntry);
                timelineEntryStarted = false;
                timeLineMap.delete(currentTimelineName);
                currentTimelineName = undefined;
                addToTimeline(timelineName, date);
            }
            dateTimeLastMeasurement = date;
        }

        function resetData() {
            diffLastSample = 0;
            forwardTemp = 0;
            timelineRows = [];
            timelineEntryStarted = false;
            timeLineMap = new Map();
            currentTimelineName = "";
        }

        $(document).ready(function () {
            $('#collection').change(function () {
                resetData();
                collection = $(this).val();
                $('#chart_div').text("Loading data...");
                drawChart();
            });

            $("#raw_data_button").click(function () {
                $("#lineChart").css("display", "block");
            });

        });

    </script>
</head>

<body>
    <div class="container">
        <h1 class="title">Status Heizen/Kühlen T71-T77</h1>
        <h2 class="subtitle">
            Der Status der Wäremepumpe/Kühlung wird anhand der Temperaturdifferenz der <a target="_blank"
                href="https://de.wikipedia.org/wiki/Vorlauftemperatur">Vor- und Rücklauftemperatur</a> ermittelt.
        </h2>
        <div class="field">
            <div class="control">
                <div class="select is-info">
                    <select id="collection">
                        <option value="t77-monitor" selected> Haus T77</option>
                        <option value="t75-monitor"> Haus T75</option>
                        <option value="t73-monitor-new"> Haus T73</option>
                        <option value="t71-monitor"> Haus T71</option>

                    </select>
                </div>
            </div>
        </div>
    </div>
    <div class="container" style="padding-top: 1em;">
        <div id="status">loading data...</div>
    </div>
    <div class="container">
        <div id="timelineChart" style="height: 180px;">Loading data...</div>
    </div>
    <div class="container">
        <button class="button is-info" id="raw_data_button">Zeige Rohdaten...</button>
    </div>

    <div id="lineChart" style="">Loading data...</div>
</body>

</html>